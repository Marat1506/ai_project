# ChatGPT Clone - Тестовое задание

Упрощённый аналог интерфейса ChatGPT с тредами, хранением сообщений в базе и генеративным UI на основе Vercel AI SDK.

## Стек технологий

- **Next.js 16** (App Router, TypeScript)
- **Vercel AI SDK UI** с `useChat` и Generative UI / tools
- **Bun 1.3+** с встроенной SQLite базой данных
- **XLSX** для работы с Excel файлами
- **Tailwind CSS** для стилизации

## Установка и запуск

### Предварительные требования

- Bun 1.3 или выше
- Node.js 18+ (для Next.js)
- OpenAI API ключ

### Шаги установки

1. **Клонируйте репозиторий** (если еще не сделано)

2. **Установите зависимости:**

   ```bash
   bun install
   ```

3. **Создайте файл `.env.local`** в корне проекта:

   ```env
   OPENAI_API_KEY=your_openai_api_key_here
   ```

4. **Инициализируйте базу данных:**

   ```bash
   bun run db:init
   ```

5. **Создайте пример XLSX файла:**

   ```bash
   bun run xlsx:create
   ```

6. **Запустите dev сервер:**

   ```bash
   bun run dev
   ```

   **Важно:** Проект должен запускаться через Bun, так как используется Bun SQLite.
   Если вы видите ошибку о том, что Bun недоступен, убедитесь, что:

   - Bun установлен: `bun --version`
   - Вы используете команду `bun run dev`, а не `npm run dev` или `yarn dev`

7. Откройте [http://localhost:3000](http://localhost:3000) в браузере

## Структура проекта

```
├── app/
│   ├── api/
│   │   ├── chat/              # API для чата с AI
│   │   ├── threads/           # API для работы с тредами
│   │   └── messages/          # API для работы с сообщениями
│   ├── layout.tsx
│   └── page.tsx               # Главная страница с чатом
├── src/
│   ├── components/
│   │   └── chat/              # Компоненты чата
│   │       ├── ChatInterface.tsx
│   │       ├── ChatMessage.tsx
│   │       ├── ThreadList.tsx
│   │       ├── ConfirmationDialog.tsx
│   │       └── TableViewer.tsx
│   ├── lib/
│   │   ├── db/                # Слой работы с БД
│   │   │   ├── db.ts
│   │   │   ├── schema.ts
│   │   │   └── init.ts
│   │   └── xlsx/              # Слой работы с XLSX
│   │       └── xlsx.ts
├── data/
│   ├── chat.db                # SQLite база данных (создается автоматически)
│   └── example.xlsx           # Пример Excel файла
└── scripts/
    └── create-example-xlsx.ts  # Скрипт для создания примера XLSX
```

## Функциональность

### 1. Чат с тредами

- ✅ Список тредов слева (как в ChatGPT)
- ✅ Создание нового треда
- ✅ Переключение между тредами
- ✅ Загрузка истории сообщений из базы
- ✅ Сохранение всех сообщений (user/assistant) в SQLite

### 2. Client-side Tools (Generative UI)

- ✅ `readExcelRange` - чтение диапазона ячеек из Excel
- ✅ `updateExcelCell` - обновление ячейки (с подтверждением)
- ✅ `updateExcelRange` - обновление диапазона (с подтверждением)
- ✅ `getCellFormula` - получение и объяснение формулы
- ✅ `deleteThread` - удаление треда (с подтверждением)

### 3. Подтверждение опасных действий

- ✅ UI-диалоги для подтверждения update/delete операций
- ✅ Кнопки "Да" / "Нет" в модальных окнах
- ✅ Действие выполняется только после подтверждения

### 4. Работа с XLSX таблицей

- ✅ Чтение диапазонов ячеек (`Sheet1!A1:B3`)
- ✅ Запись в ячейки и диапазоны (с подтверждением)
- ✅ Объяснение формул
- ✅ Модальное окно для просмотра таблицы
- ✅ Выделение ячеек мышкой
- ✅ Сохранение диапазонов как меншонов (`@Sheet1!A1:B3`)
- ✅ Использование меншонов в чате для работы с таблицей

## Использование

### Работа с тредами

1. Нажмите "+ Новый тред" для создания нового треда
2. Кликните на тред в списке для переключения
3. Все сообщения автоматически сохраняются в базу

### Работа с Excel таблицей

1. **Чтение таблицы:**

   - Спросите: "Прочитай диапазон Sheet1!A1:B5"
   - Агент вызовет tool и покажет таблицу
   - Кликните на ссылку "Показать таблицу" для открытия модального окна

2. **Выделение ячеек:**

   - В модальном окне выделите нужные ячейки мышкой
   - Нажмите "Сохранить диапазон"
   - Диапазон будет вставлен в поле ввода как меншон

3. **Использование меншонов:**

   - Введите `@` в поле ввода для просмотра сохраненных диапазонов
   - Или используйте меншон напрямую: "Объясни формулу в @Sheet1!D4"
   - Агент автоматически распознает меншоны и использует соответствующие tools

4. **Обновление таблицы:**
   - Попросите агента обновить ячейку: "Обнови Sheet1!A2 значением 'test'"
   - Появится диалог подтверждения
   - Нажмите "Да" для выполнения или "Нет" для отмены

## База данных

База данных SQLite создается автоматически при первом запуске в `data/chat.db`.

**Таблицы:**

- `threads` - треды (id, title, created_at, updated_at)
- `messages` - сообщения (id, thread_id, role, content, created_at)

## XLSX файл

Пример файла находится в `data/example.xlsx`. Вы можете заменить его на свой файл, но убедитесь, что он называется `example.xlsx`.

## Ограничения и известные проблемы

1. **Подтверждение действий:** Текущая реализация использует отправку нового сообщения для подтверждения. В production версии можно улучшить это через прямой вызов tools.

2. **Меншоны:** Меншоны сохраняются в localStorage. При очистке браузера они будут потеряны.

3. **Многопользовательский режим:** Текущая реализация не поддерживает несколько пользователей одновременно.

4. **Формулы в Excel:** Формулы читаются, но не пересчитываются автоматически при обновлении зависимых ячеек.

## Что реализовано

### Полностью реализовано:

- ✅ Чат с тредами и персистентностью
- ✅ Client-side tools с Generative UI
- ✅ Подтверждение опасных действий через UI
- ✅ Работа с XLSX (чтение, запись, формулы)
- ✅ Модальное окно для таблицы с выделением ячеек
- ✅ Меншоны диапазонов и интеграция с агентом

### Частично реализовано:

- ⚠️ Сохранение сообщений ассистента (работает, но можно улучшить)
- ⚠️ Обработка ошибок (базовая реализация)

## Разработка

### Скрипты

- `bun run dev` - запуск dev сервера
- `bun run build` - сборка для production
- `bun run start` - запуск production сервера
- `bun run db:init` - инициализация базы данных

## Лицензия

Это тестовое задание для оценки навыков разработки.
